# Generated by Django 5.2.7 on 2025-11-09 17:30

from django.db import migrations, connection


def add_type_field_if_not_exists(apps, schema_editor):
    """Add type field only if it doesn't exist - works with both SQLite and PostgreSQL"""
    db_connection = schema_editor.connection
    db_vendor = db_connection.vendor
    
    with db_connection.cursor() as cursor:
        if db_vendor == 'postgresql':
            # PostgreSQL syntax
            cursor.execute("""
                DO $$
                BEGIN
                    IF NOT EXISTS (
                        SELECT 1 FROM information_schema.columns 
                        WHERE table_name='health_records_healthrecord' 
                        AND column_name='type'
                    ) THEN
                        ALTER TABLE health_records_healthrecord 
                        ADD COLUMN type VARCHAR(50) DEFAULT 'other' NOT NULL;
                    END IF;
                END $$;
            """)
        elif db_vendor == 'sqlite':
            # SQLite syntax - check if column exists first
            cursor.execute("""
                SELECT COUNT(*) FROM pragma_table_info('health_records_healthrecord') 
                WHERE name='type'
            """)
            exists = cursor.fetchone()[0]
            
            if not exists:
                cursor.execute("""
                    ALTER TABLE health_records_healthrecord 
                    ADD COLUMN type VARCHAR(50) DEFAULT 'other' NOT NULL
                """)
        else:
            # For other databases, try to add the column (will fail if exists)
            try:
                cursor.execute("""
                    ALTER TABLE health_records_healthrecord 
                    ADD COLUMN type VARCHAR(50) DEFAULT 'other' NOT NULL
                """)
            except Exception:
                # Column might already exist, ignore
                pass


def remove_type_field(apps, schema_editor):
    """Remove type field if it exists"""
    db_connection = schema_editor.connection
    db_vendor = db_connection.vendor
    
    with db_connection.cursor() as cursor:
        if db_vendor == 'postgresql':
            cursor.execute("""
                ALTER TABLE health_records_healthrecord 
                DROP COLUMN IF EXISTS type CASCADE
            """)
        elif db_vendor == 'sqlite':
            # SQLite doesn't support DROP COLUMN easily, skip for now
            pass
        else:
            try:
                cursor.execute("""
                    ALTER TABLE health_records_healthrecord 
                    DROP COLUMN type
                """)
            except Exception:
                pass


class Migration(migrations.Migration):

    dependencies = [
        ('health_records', '0002_remove_healthrecord_file_and_more'),
    ]

    operations = [
        migrations.RunPython(
            add_type_field_if_not_exists,
            reverse_code=remove_type_field
        ),
    ]
